<!DOCTYPE html>
<html>
  <head>
    <title>Apache BookKeeper - Production Deployment</title>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="/bookkeeper-staging-site/css/normalize.css">
<link rel="stylesheet" href="/bookkeeper-staging-site/css/tippy.css">
<link rel="stylesheet" href="/bookkeeper-staging-site/css/style.css">

<link rel="shortcut icon" href="/bookkeeper-staging-site/img/favicon.ico">

<script src="/bookkeeper-staging-site/js/tippy.min.js"></script>

<script type="text/javascript">
  var shiftWindow = function() { scrollBy(0, -108); };
  window.addEventListener("hashchange", shiftWindow);
  window.addEventListener("pageshow", shiftWindow);
  function load() { if (window.location.hash) shiftWindow(); }
</script>

  </head>
  <body class="body">
    <main class="main">
      
<nav class="navbar bk-topnav">
  <div class="navbar-brand">
    <a class="navbar-item bk-brand" href="/bookkeeper-staging-site/">
      Apache BookKeeper
    </a>

    <!--
    <a class="navbar-item is-hidden-desktop bk-github" href="https://github.com/apache/bookkeeper" target="_blank">
      <span class="icon">
        <i class="fa fa-github"></i>
      </span>
    </a>

    <a class="navbar-item is-hidden-desktop bk-twitter" href="https://twitter.com/jgthms" target="_blank">
      <span class="icon">
        <i class="fa fa-twitter"></i>
      </span>
    </a>
    -->

    <div class="navbar-burger" data-target="bkNav">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <div id="bkNav" class="navbar-menu">
    <div class="navbar-start">
      <div class="navbar-item has-dropdown is-hoverable">
        <a class="navbar-link">Documentation</a>
        <div class="navbar-dropdown is-boxed">
          
          <a class="navbar-item" href="/bookkeeper-staging-site/docs/getting-started/installation">
            Release 4.5.0
            <span class="tag is-success">LATEST</span>
          </a>
          
          <hr class="dropdown-divider">
          <a class="navbar-item" href="/bookkeeper-staging-site/javadoc">
            <span class="icon bk-javadoc-icon">
              <img src="/bookkeeper-staging-site/img/java-icon.svg">
            </span>
            Javadoc
          </a>
          <hr class="dropdown-divider">
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.4.0">
            Release 4.4.0
            <span class="tag is-success">Stable</span>
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.3.2">
            Release 4.3.2
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.3.1">
            Release 4.3.1
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.3.0">
            Release 4.3.0
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.2.4">
            Release 4.2.4
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.2.3">
            Release 4.2.3
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.2.2">
            Release 4.2.2
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.2.1">
            Release 4.2.1
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.2.0">
            Release 4.2.0
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.1.0">
            Release 4.1.0
            
          </a>
          
          <a class="navbar-item" href="/bookkeeper-staging-site/archives/docs/r4.0.0">
            Release 4.0.0
            
          </a>
          
        </div>
      </div>

      <div class="navbar-item has-dropdown is-hoverable">
        <a class="navbar-link">Community</a>
        <div class="navbar-dropdown is-boxed">
          <a class="navbar-item" href="/bookkeeper-staging-site/community/mailing-lists">Mailing lists</a>
          <a class="navbar-item" href="/bookkeeper-staging-site/community/slack">Slack</a>
          <a class="navbar-item" href="/bookkeeper-staging-site/community/contributing">Contributing</a>
          <a class="navbar-item" href="https://issues.apache.org/jira/projects/BOOKKEEPER">JIRA Issue Tracker</a>
        </div>
      </div>

      <div class="navbar-item has-dropdown is-hoverable">
        <a class="navbar-link">Project</a>
        <div class="navbar-dropdown is-boxed">
          <a class="navbar-item" href="/bookkeeper-staging-site/project/who">Who are we?</a>
          <a class="navbar-item" href="/bookkeeper-staging-site/project/bylaws">Bylaws</a>
          <a class="navbar-item" href="http://www.apache.org/licenses/">License</a>
          <hr class="dropdown-divider">
          <a class="navbar-item" href="/bookkeeper-staging-site/project/privacy">Privacy policy</a>
          <a class="navbar-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsorship</a>
          <a class="navbar-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a>
        </div>
      </div>
    </div>

    <div class="navbar-end">
      <div class="navbar-item">
        <div class="field is-grouped">
          <p class="control">
            <a class="button bk-twitter" href="https://twitter.com/asfbookkeeper">
              <span class="icon">
                <i class="fa fa-twitter"></i>
              </span>
              <span>Twitter</span>
            </a>
          </p>
          <p class="control">
            <a class="button" href="https://github.com/apache/bookkeeper">
              <span class="icon">
                <i class="fa fa-github"></i>
              </span>
              <span>GitHub</span>
            </a>
          </p>
          <p class="control">
            <a class="button is-primary" href="/bookkeeper-staging-site/releases">
              <span class="icon">
                <i class="fa fa-download"></i>
              </span>
              <span>Download</span>
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</nav>


      <div class="bk-docs-container">
  <div class="columns is-gapless">
    <div class="column is-2 is-hidden-mobile">
      <div class="container">
        
<aside class="sidebar">
  
  <p>
    Getting started
  </p>
  <ul class="sidebar-items">
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/getting-started/installation">
      Installation
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/getting-started/run-locally">
      Run bookies locally
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/getting-started/concepts">
      Concepts and architecture
      </a>
    </li>
    
  </ul>
  
  <p>
    Deployment
  </p>
  <ul class="sidebar-items">
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/deployment/manual">
      Manual deployment
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/deployment/dcos">
      BookKeeper on DC/OS
      </a>
    </li>
    
  </ul>
  
  <p>
    Administration
  </p>
  <ul class="sidebar-items">
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/admin/production">
      Production Deployment
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/admin/bookies">
      BookKeeper administration
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/admin/autorecovery">
      AutoRecovery
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/admin/metrics">
      Metric collection
      </a>
    </li>
    
  </ul>
  
  <p>
    API
  </p>
  <ul class="sidebar-items">
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/api/overview">
      Overview
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/api/ledger-api">
      Ledger API
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/api/distributedlog-api">
      DistributedLog
      </a>
    </li>
    
  </ul>
  
  <p>
    Development
  </p>
  <ul class="sidebar-items">
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/development/protocol">
      BookKeeper protocol
      </a>
    </li>
    
  </ul>
  
  <p>
    Reference
  </p>
  <ul class="sidebar-items">
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/reference/config">
      Configuration
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/reference/cli">
      Command-line tools
      </a>
    </li>
    
    
    <li>
      <a href="/bookkeeper-staging-site/docs/reference/metrics">
      Metrics
      </a>
    </li>
    
  </ul>
  
  <hr />
  <a class="button is-info">
    Latest version: 4.5.0
  </a>
</aside>

      </div>
    </div>

    <div class="column is-8 bk-docs-block">
      <header class="docs-title">
        <nav class="level bk-level">
          <div class="level-left">
            <div class="level-item">
              <h1 class="title">Production Deployment</h1>
            </div>
          </div>
          
        </nav>

        <h2 class="subtitle">Considerations, Best Practices and Import Configurations for production deployment</h2>
      </header>

      <hr />

      <div class="content">
        <section class="bk-main-content">
          <p>This document covers the key things to consider before putting your cluster live in production.
It is not meant to be a comprehensive guide to running your BookKeeper cluster in production.</p>

<p>It covers following three main areas:</p>

<ul>
  <li>Logistical considerations, such as hardware recommendations and deployment strategies.</li>
  <li>Configuration settings that are more suitable for a production environment.</li>
  <li>Actions after deployment, such as <code class="highlighter-rouge">autorecovery</code> and production monitoring.</li>
</ul>

<h2 id="hardware">Hardware</h2>

<p>If you have been following the <a href="../deployment/manual">deployment</a> guide, you’ve probably played with BookKeeper on your laptop locally or on a small cluster of machines laying around.
But when it comes to deploying BookKeeper to production, there are a few recommendations that you should consider. These recommendations will provide good starting points based on
the experiences with production clusters.</p>

<h3 id="cpu">CPU</h3>

<p>Apache BookKeeper is a storage system, which is most likely bound by I/O and network. As such, the exact processor setup matters less than other resources (e.g. disks and network).
However if <a href="../security/tls">TLS</a> is enabled, the CPU requirements can be significantly higher. The exact details depend on the CPU type and JVM implementation on TLS.</p>

<p>It is recommended to choose a modern processor with multiple cpu cores. Common deployments utilize 24 core machines. If you need to choose between faster CPUs or more cores, choose
<em>more cores</em>. The extra concurrency that multiple cores offers will far outweigh a slightly faster clock speed.</p>

<h3 id="memory">Memory</h3>

<p>The memory usage on Bookies comes from different places.</p>

<ul>
  <li><code class="highlighter-rouge">JVM Heap</code>: Most of the object allocations happen on jvm heap. However they are not long-lived objects and will quickly be garbage collected. Bookies use heap space very carefuly
  and does not require setting a large heap size. However if you are using <code class="highlighter-rouge">SortedLedgerStorage</code> as the ledger storage implementation, the latest written data will be buffered in
  a on-heap skiplist map before flushing to disks. You need to adjust the heap size to accommondate the space for the skiplist map.</li>
  <li><code class="highlighter-rouge">JVM Direct Memory</code>: Bookies use direct memory extensively in order to reduce the objects allocated on heap and prevent long pauses during JVM garbage collection. The direct memory
  usage is mainly comes from <code class="highlighter-rouge">index page cache</code> and <code class="highlighter-rouge">netty io</code>.</li>
  <li><code class="highlighter-rouge">Kernel Pagecache</code>: Although bookies don’t rely directly on filesystem for caching latest data. The data flushed from memory table will still be written to filesystem and cached in pagecache
  for random reads or <code class="highlighter-rouge">catch-up</code> reads. Reserve certain amount of memory for filesystem pagecache will help <code class="highlighter-rouge">random</code> and <code class="highlighter-rouge">catch-up</code> reads.</li>
</ul>

<p>A simple rule as below is helpful for the memory capacity planning. This assumes that you are using <code class="highlighter-rouge">SortedLedgerStorage</code> as the ledger store.</p>

<ul>
  <li><code class="highlighter-rouge">direct memory</code> is mainly used by <code class="highlighter-rouge">ledger cache</code> and <code class="highlighter-rouge">netty io</code>. The memory in <code class="highlighter-rouge">netty io</code> is used for receiving data and sending data. You typically don’t need memory higher than
  your nic’s bandwidth; while the memory in <code class="highlighter-rouge">ledger cache</code> depends on the number of active ledgers and the corresponding index page size, you can compute the memory need as <code class="highlighter-rouge">active-ledgers * index-page-size</code>,
  and allocate 2 or 3 times of the calcuated memory.</li>
  <li>once you figure out the <code class="highlighter-rouge">direct memory</code> size, you can configure your jvm heap size to be same as the <code class="highlighter-rouge">direct memory</code> size.</li>
  <li>In order to have better performance for fanout reads, you need sufficient memory for filesystem to buffer data for active readers. You can do a back-of-the-envelope estimate of memory
  needs by assuming you want to be able to buffer for 30 seconds and compute your filesystem page cache need as <code class="highlighter-rouge">write_throughput * 30</code>.</li>
</ul>

<p>A machine with 64GB of RAM is a decent choice to cover a lot of common use cases. However if your applications don’t have a lot of read activities, you can use machines wit smaller memory.</p>

<p>See more details in [../development] to better understand BookKeeper’s I/O architecture.</p>

<h3 id="-disks"><a name="disks"></a> Disks</h3>

<p>In order for bookies to provide optimal performance, it’s essential that bookies have suitable disk configuration. There are two key dimensions to bookie’s disk configuration:</p>

<ul>
  <li>Disk I/O bandwidth</li>
  <li>Storage capacity</li>
</ul>

<p>Data written to bookies are always synced to disk before returning an acknowledgement to the clients. To achieve I/O isolation and ensure low write latency, bookies are designed to leverage multiple
devices for different purposes.</p>

<ul>
  <li>A <code class="highlighter-rouge">journal directory</code> is used for ensuring durability. It is critical to have a dedicated device for <code class="highlighter-rouge">journal</code>, in order to have fast <a href="https://linux.die.net/man/2/fsync">fsync</a> operations.
  Typically, small and fast <a href="https://en.wikipedia.org/wiki/Solid-state_drive">solid-state drives</a> (SSDs) should suffice, or <a href="https://en.wikipedia.org/wiki/Hard_disk_drive">hard disk drives</a>
  (HDDs) with a <a href="https://en.wikipedia.org/wiki/RAID">RAID</a>s controller and a battery-backed write cache. Both solutions can ensure fsync latency of half millisecond.
  (NOTE: multiple journal devices are supported since 4.5.0 release.)</li>
  <li>Multiple <code class="highlighter-rouge">ledger directories</code> are used for storing data. The data written into <code class="highlighter-rouge">ledger directories</code> in background, so write I/O in general is not a big concern. Reads will happen sequentially most
  of the time. To store large amounts of data, a typical configuration will involve multiple HDDs with a RAID controller. If your applications will have extensive random rands to bookkeeper cluster,
  SSDs are preferred over HDDs.</li>
  <li>It is optionally to configure multiple <code class="highlighter-rouge">index directories</code> for storing the index data. The data written into <code class="highlighter-rouge">ledger directories</code> are huge and mostly sequentially, while the data written to
  <code class="highlighter-rouge">index</code> are small and mostly randomly. If you are using HDDs for <code class="highlighter-rouge">ledger directories</code>, it is recommended to have a small dedicated device as <code class="highlighter-rouge">index directory</code>. This ensures writing flushing index
  files won’t impact your normal writes.</li>
</ul>

<p>You can either RAID the devices together into a single volume or format and mount each drive as its owner directory.</p>

<p>For example, if you have 2 SSDs (<code class="highlighter-rouge">/dev/ssd1</code> and <code class="highlighter-rouge">/dev/ssd2</code>) and 6 HDDs (<code class="highlighter-rouge">/dev/hdd{0-5}</code>), you have multiple options to configure them.
The first option, you can raid those 2 ssds into one volume (<code class="highlighter-rouge">/dev/journal</code>) and use it as the <code class="highlighter-rouge">journal device</code>, and raid the other 6 HDDs into another volume (<code class="highlighter-rouge">/dev/ledger</code>) for the <code class="highlighter-rouge">ledger device</code>;
Or you can mount them individually and configure a list of directories for <code class="highlighter-rouge">journal</code> and <code class="highlighter-rouge">ledger</code>.</p>

<p>If you configure multiple journal directories, the data will be assigned by ledger ids to journal directories. Each ledger will only be written in one of the <code class="highlighter-rouge">journal</code> directories. If throughput is not
well balanced among ledgers this can lead to load imbablance between journal disks.</p>

<p>RAID can potentially do better at balancing load between disks because it balances load at a lower level and also improve the ability to tolerate disk failures, which is good for operating a large
cluster. The primary downside of RAID is that it reduces the disk capacity.</p>

<p>See more details in [../development] to better understand BookKeeper’s I/O architecture.</p>

<h3 id="network">Network</h3>

<p>Although bookies don’t have strict requirements on networking, a <em>fast</em> and <em>reliable</em> network is recommended for performance considerations. Modern data-center networking (e.g. 1GbE, 10GbE) is
sufficient for the vast majority of clusters. <code class="highlighter-rouge">10GbE</code> is recommended since the software can take full advantages of that.</p>

<p>BookKeeper can be deployed either within one data center or spanning multiple data centers. It also provides multiple placement policies to place the replicas in your cluster, to better utilize
the resources according to your network topologies. See [Placement Policies](#placement-policies] on how to configure the placement polices.</p>

<h3 id="filesystem">Filesystem</h3>

<p><code class="highlighter-rouge">XFS</code> or <code class="highlighter-rouge">Ext4</code> is recommended to run bookies.</p>

<h2 id="jvm">JVM</h2>

<p>It is recommended to run BookKeeper on latest version of JDK 1.8 with the <a href="http://www.oracle.com/technetwork/tutorials/tutorials-1876574.html">G1</a> collector.</p>

<p>One recommended GC tuning looks like this:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>    -Xms2g -Xmx2g -XX:MaxDirectMemorySize<span class="o">=</span>2g <span class="se">\</span>
    -XX:+UseG1GC -XX:MaxGCPauseMillis<span class="o">=</span>10 -XX:+ParallelRefProcEnabled -XX:+UnlockExperimentalVMOptions <span class="se">\</span>
    -XX:+AggressiveOpts -XX:+DoEscapeAnalysis -XX:ParallelGCThreads<span class="o">=</span>32 -XX:ConcGCThreads<span class="o">=</span>32 -XX:G1NewSizePercent<span class="o">=</span>50 -XX:+DisableExplicitGC -XX:-ResizePLAB
</code></pre>
</div>

<p>If you are looking for using <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/cms.html">Concurrent Mark Sweep</a> (CMS) Collector, you can
follow following settings:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>    -Xms2g -Xmx2g -XX:MaxDirectMemorySize<span class="o">=</span>2g -XX:MaxMetaspaceSize<span class="o">=</span>128M -XX:MetaspaceSize<span class="o">=</span>128M <span class="se">\</span>
    -XX:ParallelGCThreads<span class="o">=</span><span class="k">${</span><span class="nv">JVM_NUM_GC_THREADS</span><span class="k">}</span> <span class="se">\</span>
    -XX:+CMSScavengeBeforeRemark <span class="se">\</span>
    -XX:TargetSurvivorRatio<span class="o">=</span>90 <span class="se">\</span>
    -XX:+UseConcMarkSweepGC
</code></pre>
</div>

<p>It is also a good practise to include gc log related settings to dump the gc details to a log file for performance troubleshooting.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>    -Xloggc:gc.log -XX:+PrintCommandLineFlags -verbosegc <span class="se">\</span>
    -XX:NumberOfGCLogFiles<span class="o">=</span>2 -XX:GCLogFileSize<span class="o">=</span>64M -XX:+UseGCLogFileRotation <span class="se">\</span>
    -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -XX:+PrintGCCause -XX:+PrintPromotionFailure -XX:+PrintTenuringDistribution -XX:+PrintHeapAtGC <span class="se">\</span>
    -XX:+HeapDumpOnOutOfMemoryError
</code></pre>
</div>

<h2 id="configuration">Configuration</h2>

<p>BookKeeper ships with very good defaults, especially when it comes to performance-related settings and options. When in doubt, just leave the settings alone.</p>

<p>With that said, there are some logistical configurations that should be changed for production. These changes are necessary either to make your life easier, or
because their is no way to set a good default (because it depends on your cluster layout).</p>

<p>Here is a list of important steps for you to follow to configure your cluster and clients.</p>

<ol>
  <li>Decide where to store your metadata.</li>
  <li>Configure your bookie storage.</li>
  <li>Choose your placement policy for clients.</li>
</ol>

<h3 id="decide-where-to-store-your-metadata">Decide where to store your metadata</h3>

<p>Currently ZooKeeper is the default metadata storage for BookKeeper. You are recommended to use either <code class="highlighter-rouge">LongHierarchicalLedgerManagerFactory</code> or <code class="highlighter-rouge">HierarchicalLedgerManagerFactory</code>
as the <code class="highlighter-rouge">ledger manager</code>. <code class="highlighter-rouge">HierarchicalLedgerManagerFactory</code> was introduced since <code class="highlighter-rouge">4.2.0</code> and most widely used, however it has a limitation on the number of ledgers
that it can be allocated (currently it is bound at 2^32); while <code class="highlighter-rouge">LongHierarchicalLedgerManagerFactory</code> was introduced in <code class="highlighter-rouge">4.5.0</code> to overcome this limitation. If you use <code class="highlighter-rouge">LedgerHandleAdv</code>
API to generate ledger id by yourself, it is strongly recommended to use <code class="highlighter-rouge">LongHierarchicalLedgerManagerFactory</code>, so you will not encounter the limitation in <code class="highlighter-rouge">HierarchicalLedgerManagerFactory</code>.</p>

<p>Below are some important settings you need to configure for both your bookies and clients.</p>

<p><code class="highlighter-rouge">ledgerManagerFactoryClass</code></p>

<p>The ledger manager factory implementation that the cluster is using.</p>

<ul>
  <li>Type: String</li>
  <li>Required: <code class="highlighter-rouge">true</code></li>
  <li>Values:
    <ul>
      <li><code class="highlighter-rouge">org.apache.bookkeeper.meta.FlatLedgerManagerFactory</code></li>
      <li><code class="highlighter-rouge">org.apache.bookkeeper.meta.HierarchicalLedgerManagerFactory</code></li>
      <li><code class="highlighter-rouge">org.apache.bookkeeper.meta.LongHierarchicalLedgerManagerFactory</code></li>
      <li><code class="highlighter-rouge">org.apache.bookkeeper.meta.MSLedgerManagerFactory</code></li>
    </ul>
  </li>
</ul>

<p><code class="highlighter-rouge">zkLedgersRootPath</code></p>

<p>Root zookeeper path to store the ledger metadata. This parameter is used by zookeeper-based ledger managers as a root znode to store all the ledger metadata.</p>

<ul>
  <li>Type: String</li>
  <li>Required: <code class="highlighter-rouge">true</code> if <code class="highlighter-rouge">ledgerManagerFactoryClass</code> is zookeeper based.</li>
  <li>Default: <code class="highlighter-rouge">/ledgers</code></li>
</ul>

<p><code class="highlighter-rouge">metastoreImplClass</code></p>

<p>The metastore implementation used by <code class="highlighter-rouge">MSLedgerManagerFactory</code>. This parameter is used by metastore interface based ledger managers.</p>

<ul>
  <li>Type: String</li>
  <li>Required: <code class="highlighter-rouge">true</code> if <code class="highlighter-rouge">ledgerManagerFactoryClass</code> is <code class="highlighter-rouge">MSLedgerManagerFactory</code>.</li>
</ul>

<p>You can checkout <a href="../developement">ledger metadata management</a> to learn more details.</p>

<h3 id="configure-your-bookie-storage">Configure your bookie storage</h3>

<p>As described in <a href="#disks">disks</a> section, you have to configure <code class="highlighter-rouge">ledgerDirectories</code> and <code class="highlighter-rouge">journalDirectories</code> in order to run a bookie. This is important as
they are used for storing the data written to bookie. It is also recommended to have separate devices for journals and ledger storage.</p>

<p><code class="highlighter-rouge">journalDirectories</code></p>

<p>The directories to which Bookies output its write-ahead-log (WAL). You can define multiple directories to store write ahead logs separated by a comma.</p>

<ul>
  <li>Type: String</li>
  <li>Required: <code class="highlighter-rouge">true</code></li>
  <li>Format: a list of directories separated by a comma, for example, <code class="highlighter-rouge">/tmp/dir1,/tmp/dir2</code>.</li>
</ul>

<p><code class="highlighter-rouge">ledgerDirectories</code></p>

<p>The directories to which Bookies output ledger snapshots. You can define multiple directories to store snapshots separated by a comma.</p>

<ul>
  <li>Type: String</li>
  <li>Required: <code class="highlighter-rouge">true</code></li>
  <li>Format: a list of directories separated by a comma, for example, <code class="highlighter-rouge">/tmp/dir1,/tmp/dir2</code>.</li>
</ul>

<p><code class="highlighter-rouge">indexDirectories</code></p>

<p>The directories to which Bookie output its index files. If not specified, the value of <code class="highlighter-rouge">ledgerDirectories</code> will be used as index directories.
It is good to configure a separated device for index files if you are using HDDs for <code class="highlighter-rouge">ledgerDirectories</code>.</p>

<ul>
  <li>Type: String</li>
  <li>Required: optional. better to configure if <code class="highlighter-rouge">ledgerDirectories</code> are on HDDs.</li>
  <li>Format: a list of directories separated by a comma, for example, ‘/tmp/dir1,/tmp/dir2`.</li>
</ul>

<h4 id="journal-performance-tuning">Journal Performance Tuning</h4>

<p>The default settings are pretty good for running bookies for most of the application and still achieve pretty low latency. However if you want to
customize your journal settings, below are a few settings that you need to know.</p>

<p><code class="highlighter-rouge">journalMaxGroupWaitMSec</code></p>

<p>Maximum latency to impose on a journal write to achieve grouping.</p>

<ul>
  <li>Type: Integer</li>
  <li>Default: <code class="highlighter-rouge">2</code></li>
</ul>

<p><code class="highlighter-rouge">journalFlushWhenQueueEmpty</code></p>

<p>A journal flush will be triggered when journal queue is empty. If it is <code class="highlighter-rouge">true</code>, <code class="highlighter-rouge">journalMaxGroupWaitMSec</code> will be ignored.</p>

<ul>
  <li>Type: Boolean</li>
  <li>Default: <code class="highlighter-rouge">false</code></li>
</ul>

<p><code class="highlighter-rouge">journalBufferedWritesThreshold</code></p>

<p>Maximum bytes to buffer to achieve grouping.</p>

<ul>
  <li>Type: Integer</li>
  <li>Default: <code class="highlighter-rouge">512KB</code></li>
</ul>

<p>It is strongly recommended to configure <code class="highlighter-rouge">journalMaxGroupWaitMSec</code> and disable <code class="highlighter-rouge">journalFlushWhenQueueEmpty</code>. This would ensure predictable latency on
fsyncing journals even during traffic spikes. A value of 2 to 4 milliseconds is in general good for <code class="highlighter-rouge">journalMaxGroupWaitMSec</code>. Enabling <code class="highlighter-rouge">journalFlushWhenQueueEmpty</code>
can have a slightly better latency when your traffic is low, however your latency will become spiky when the traffic becomes bursty.</p>

<h3 id="-choose-your-placement-policy-for-clients"><a name="placement-policies"></a> Choose your placement policy for clients</h3>

<p>BookKeeper provides a few built-in placement policies to placement replicas in different racks or regions (aka data centers) according to the cluster’s network topology.</p>

<p>The available placement policies are listed as below:</p>

<ul>
  <li><code class="highlighter-rouge">default</code>: <code class="highlighter-rouge">org.apache.bookkeeper.client.DefaultEnsemblePlacementPolicy</code></li>
  <li><code class="highlighter-rouge">rack-aware</code>: <code class="highlighter-rouge">org.apache.bookkeeper.client.RackawareEnsemblePlacementPolicy</code></li>
  <li><code class="highlighter-rouge">region-aware</code>: <code class="highlighter-rouge">org.apache.bookkeeper.client.RegionAwareEnsemblePlacementPolicy</code></li>
</ul>

<p>If you don’t care about the network topology or run the cluster in an environment where network topology is unclear, you can use <code class="highlighter-rouge">default</code> placement policy (you don’t have
anything to worry about); if you are running the cluster in a single data center where network topology can be retrieved, you can configure your clients to use
<code class="highlighter-rouge">rack-aware</code> placement policy; or if your are running a cluster spanning over multiple data centers, you can configure your clients to use <code class="highlighter-rouge">region-aware</code> placement policy.</p>

<p>To configure which placement policy, you need specify the placement policy class in following setting:</p>

<p><code class="highlighter-rouge">ensemblePlacementPolicy</code></p>

<ul>
  <li>Type: String</li>
  <li>Format: Class name of the placement policy implementation.</li>
</ul>

<p>For <code class="highlighter-rouge">rack-aware</code> and <code class="highlighter-rouge">region-aware</code> placement policies, you can either configure a <code class="highlighter-rouge">DNSResolver</code> in client builder or specify a <code class="highlighter-rouge">DNSResover</code> class in client configuration.</p>

<p><code class="highlighter-rouge">reppDnsResolverClass</code></p>

<ul>
  <li>Type: String</li>
  <li>Format: Class name of the <code class="highlighter-rouge">DNSResolver</code> implementation.</li>
</ul>

<p>If you don’t configure a <code class="highlighter-rouge">DNSResolver</code>, it will use a <code class="highlighter-rouge">ScriptBasedMapping</code> dns resolver, which it uses a script to resolve bookies’ network locations. The script can be configured
in following settings:</p>

<p><code class="highlighter-rouge">networkTopologyScriptFileName</code></p>

<ul>
  <li>Type: String.</li>
  <li>Format: File path. The path points to a script file.</li>
</ul>

<p><code class="highlighter-rouge">networkTopologyScriptNumberArgs</code></p>

<ul>
  <li>Type: Integer</li>
  <li>Description: the number of arguments used by the script defined in <code class="highlighter-rouge">networkTopologyScriptFileName</code>.</li>
</ul>

<p>Please check <a href="../placement-policy">Placement Policies</a> to learn more details.</p>

<h2 id="file-descriptors">File Descriptors</h2>

<p>Currently the large number of files is used by the bookies for storing the index files, when using <code class="highlighter-rouge">InterleavedLedgerStorage</code> or <code class="highlighter-rouge">SortedLedgerStorage</code>. At the same
time, Bookies uses a large number of sockets to communicate with the clients. All of this requires a relatively high number of available file descriptors.</p>

<p>Many modern Linux distributions ship with a paltry <code class="highlighter-rouge">1024</code> file descriptors allowed per process. This is far too low for even a small bookie node, let alone one that
hosts more than thousands of ledgers.</p>

<p>It is strongly recommended to increate the file descriptor count to something very large, such as <code class="highlighter-rouge">100,000</code>. This process is irritatingly difficult and highly dependent
on your particular OS and distribution. Consult the documentation for your OS to determine how best to change the allowed file descriptor count.</p>

<p>Beside setting a proper allowed file descriptor count, you should also configure <code class="highlighter-rouge">openFileLimit</code> in bookies to prevent bookie swapping ledger indexes from memory to disk
too often. Too frequent swap will affect performance. You can tune this number to gain performance according to your requirements. Also when you change this value,
please also adjust the jvm memory settings accordingly in order for the JVM to be able to hold the ledger cache in memory.</p>

<h2 id="zookeeper">ZooKeeper</h2>

<h3 id="stable-version">Stable version</h3>

<p>It is recommended to run zookeeper 3.4.6 or later.</p>

<h3 id="operation-notes">Operation Notes</h3>

<ul>
  <li>Redundancy in the physical/hardware/network layout: try not to put them all in the same rack, decent (but don’t go nuts) hardware,
  try to keep redundant power and network paths, etc. A typical ZooKeeper ensemble has 5-7 servers, which tolerates 2 and 3 servers down,
  respectively. If you have a small deployment, then using 3 servers is acceptable, but keep in mind that you’ll only be able to tolerate 1 server down in this case.</li>
  <li>I/O segregation: if you do a lot of write type traffic you’ll almost definitely want the transaction logs on a dedicated disk group.
  Writes to the transaction log are synchronous (but batched for performance), and consequently, concurrent writes can significantly affect performance.
  ZooKeeper snapshots can be one such a source of concurrent writes, and ideally should be written on a disk group separate from the transaction log. 
  Snapshots are writtent to disk asynchronously, so it is typically ok to share with the operating system and message log files.
  You can configure a server to use a separate disk group with the <code class="highlighter-rouge">dataLogDir</code> parameter.</li>
  <li>Application segregation: Unless you really understand the application patterns of other apps that you want to install on the same box,
  it can be a good idea to run ZooKeeper in isolation (though this can be a balancing act with the capabilities of the hardware). If you do end up sharing the ensemble,
  you might want to use the <a href="https://zookeeper.apache.org/doc/r3.4.6/zookeeperProgrammers.html#ch_zkSessions">chroot</a> feature. With chroot, you give each application its own namespace.</li>
  <li>Use care with virtualization: In general, there is no problem with using ZooKeeper in a virtualized environment. It is best to place servers in different availability
  zones to avoid correlated crashes and to make sure that the storage system available can accommodate the requirements of the transaction logging and snapshotting of ZooKeeper.
  Persistence volumes are strongly recommended to use in a cloud environment. Also, keep in mind that there might be issues in ZooKeeper related to name resolution in the the cloude,
  typically related to JVM DNS caching, you are recommended to add <code class="highlighter-rouge">-Dnetworkaddress.cache.ttl=60 -Dnetworkaddress.cache.negative.ttl=60</code> as the system properties to run your zookeeper servers.</li>
  <li>JVM: ZooKeeper is an in-memory metadata store. Make sure you give zookeeper <code class="highlighter-rouge">enough</code> heap space for holding the metadata you need to store for ledgers. We don’t have a good formula for
  calculating the memory needed for a certain number of ledgers. But keep in mind that large number of ledgers means that snapshots of zookeeper can become large, and large snapshots affect
  recovery time. If the snapshot becomes too large (a few gigabytes), then you may need to increate the <code class="highlighter-rouge">initLimit</code> parameter in zookeeper to give enough time for zookeeper servers to recover
  and join the ensemble.</li>
  <li>Observers: It is recommended to add <a href="https://zookeeper.apache.org/doc/r3.4.6/zookeeperObservers.html">observers</a> when your have large number of readers in the cluster.</li>
  <li>Additional admin documentation: If you need some additional detail about the administration of ZooKeeper, the <a href="https://zookeeper.apache.org/doc/r3.4.6/zookeeperAdmin.html">admin guide</a> contains more material.</li>
</ul>

        </section>

        
        <nav class="pagination is-centered">
          
          <a class="pagination-previous" href="./index.html">Previous</a>
          
          
          <a class="pagination-next" href="./post-deployment">Next</a>
          
          <ul class="pagination-list"></ul>
        </nav>
        
      </div>
    </div>

    <div class="column is-2 is-hidden-mobile">
      
      
<div class="toc">
  <h2 class="title">Production Deployment</h2>
  <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#hardware">Hardware</a></li>
<li class="toc-entry toc-h3"><a href="#cpu">CPU</a></li>
<li class="toc-entry toc-h3"><a href="#memory">Memory</a></li>
<li class="toc-entry toc-h3"><a href="#-disks"> Disks</a></li>
<li class="toc-entry toc-h3"><a href="#network">Network</a></li>
<li class="toc-entry toc-h3"><a href="#filesystem">Filesystem</a></li>
<li class="toc-entry toc-h2"><a href="#jvm">JVM</a></li>
<li class="toc-entry toc-h2"><a href="#configuration">Configuration</a></li>
<li class="toc-entry toc-h3"><a href="#decide-where-to-store-your-metadata">Decide where to store your metadata</a></li>
<li class="toc-entry toc-h3"><a href="#configure-your-bookie-storage">Configure your bookie storage</a></li>
<li class="toc-entry toc-h4"><a href="#journal-performance-tuning">Journal Performance Tuning</a></li>
<li class="toc-entry toc-h3"><a href="#-choose-your-placement-policy-for-clients"> Choose your placement policy for clients</a></li>
<li class="toc-entry toc-h2"><a href="#file-descriptors">File Descriptors</a></li>
<li class="toc-entry toc-h2"><a href="#zookeeper">ZooKeeper</a></li>
<li class="toc-entry toc-h3"><a href="#stable-version">Stable version</a></li>
<li class="toc-entry toc-h3"><a href="#operation-notes">Operation Notes</a></li>
</ul>
</div>


      
    </div>
  </div>
</div>



<div id="entry-popover-html" class="popover-template">
  <p>An entry is a sequence of bytes (plus some metadata) written to a BookKeeper ledger. Entries are also known as records.</p>

</div>

<div id="ledger-popover-html" class="popover-template">
  <p>A ledger is a sequence of entries written to BookKeeper. Entries are written sequentially to ledgers and at most once, giving ledgers append-only semantics.</p>

</div>

<div id="bookie-popover-html" class="popover-template">
  <p>A bookie is an individial BookKeeper storage server.</p>

<p>Bookies store the content of ledgers and act as a distributed ensemble.</p>

</div>

<div id="rereplication-popover-html" class="popover-template">
  <p>A subsystem that runs in the background on bookies to ensure that ledgers are fully replicated even if one bookie from the ensemble is down.</p>

</div>

<div id="striping-popover-html" class="popover-template">
  <p>Striping is the process of distributing BookKeeper ledgers to sub-groups of bookies rather than to all bookies in a BookKeeper ensemble.</p>

<p>Striping is essential to ensuring fast performance.</p>

</div>

<div id="journal-popover-html" class="popover-template">
  <p>A journal file stores BookKeeper transaction logs.</p>

</div>

<div id="fencing-popover-html" class="popover-template">
  <p>When a reader forces a ledger to close, preventing any further entries from being written to the ledger.</p>

</div>

<div id="record-popover-html" class="popover-template">
  <p>A record is a sequence of bytes (plus some metadata) written to a BookKeeper ledger. Records are also known as entries.</p>

</div>


<script type="text/javascript">

tippy('#entry-popover', {
  html: '#entry-popover-html',
  arrow: true,
  animation: 'fade'
});

tippy('#ledger-popover', {
  html: '#ledger-popover-html',
  arrow: true,
  animation: 'fade'
});

tippy('#bookie-popover', {
  html: '#bookie-popover-html',
  arrow: true,
  animation: 'fade'
});

tippy('#rereplication-popover', {
  html: '#rereplication-popover-html',
  arrow: true,
  animation: 'fade'
});

tippy('#striping-popover', {
  html: '#striping-popover-html',
  arrow: true,
  animation: 'fade'
});

tippy('#journal-popover', {
  html: '#journal-popover-html',
  arrow: true,
  animation: 'fade'
});

tippy('#fencing-popover', {
  html: '#fencing-popover-html',
  arrow: true,
  animation: 'fade'
});

tippy('#record-popover', {
  html: '#record-popover-html',
  arrow: true,
  animation: 'fade'
});

</script>

    </main>

    <footer class="footer">
  <div class="container">
    <div class="content has-text-centered">
      <p>
        Copyright &copy; 2016 - 2017 <a href="https://www.apache.org/">The Apache Software Foundation</a>,<br /> licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0">Apache License, version 2.0</a>.
      </p>
    </div>
  </div>
</footer>

  </body>

  <script src="/bookkeeper-staging-site/js/app.js"></script>

</html>
